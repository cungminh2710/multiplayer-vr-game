<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Game Rooms | LoVR</title>
    <!-- dummy Symbol polyfill -->
    <script>
        if (typeof(Symbol) === "undefined") {
            window.Symbol = function(arg) {
                return arg;
            }
        }
    </script>

    <!-- colyseus.js 0.7.0 client -->
    <script type="text/javascript" src="https://rawgit.com/gamestdio/colyseus.js/0.7.0/dist/colyseus.js"></script>
    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="webtheme.css">
</head>

<body>

  <ul class="navlist">
    <div class="pull-left">
      <li class="navLogo"><a href="#" class="logo-brand">LoVR</a></li>
      <li class="navitem">
        <a href="/profile.html"><i class="fa fa-lg fa-user-circle-o" aria-hidden="true"></i>   Profile</a>
      </li>
      <li class="navitem">
        <a href="/game-rooms.html"><i class="fa fa-lg fa-gamepad" aria-hidden="true"></i>   Game Room</a>
      </li>
    </div>

    <div class="pull-right">
      <li class="navitem">
        <a href="#">Logout   <i class="fa fa-lg fa-sign-out" aria-hidden="true"></i></a>
      </li>
    </div>
  </ul>


    <div class="gameroom">

    <h1>Game Rooms</h1>

    <strong>Game Room</strong><br>

    <form id="form">
        <input type="text" id="game-name" value="" placeholder="Game Room Name" />
        <input type="number" id="game-max-players" step="2" min="2" max="6" value="" required placeholder="Max Players" />
        <input id="submit-create-room" class="rm-btn" type="submit" value="Create" />
    </form>

    </div>

    <!-- <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#ready-modal">Open Modal</button> -->

    <div id="ready-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Modal Header</h4>
                </div>
                <div class="modal-body">
                    <p>CONGRATS, YOUR ROOM IS READY:
                        <a id="arena-url">Click here</a>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>

    <div class="gameroom">

    <div id="current-rooms">
        <h3>Available Rooms</h3>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Num Players</th>
                    <th>Max Num Players</th>
                    <th>Join</th>
                </tr>
            </thead>
            <tbody id="current-rooms-tbody">
<!--                 <tr>
                    <td>Something here</td>
                    <td>Something here</td>
                    <td>Something here</td>
                    <td>Something here</td>
                </tr>
 -->            </tbody>
        </table>
    </div>


    <div id="my-room" style="max-width: 400px; margin: auto;">
        <h3>My Room</h3>
        <h4>Members</h4>
        <ul id="player-list">

        </ul>
        <button id="leave-room" class="rm-btn btn-leave" disabled>Leave</button>
        <button id="player-ready" class="rm-btn btn-ready" disabled>I'm Ready</button>
    </div>
    </div>
    <script>
        var host = window.document.location.host.replace(/:.*/, '');
        var client = new Colyseus.Client('ws://' + host + (location.port ? ':' + location.port : ''));
        var myPlayerName = client.id;
        var gameRoom = client.join("game-room", {
            client: client.id
        });

        var globalState = {};
        gameRoom.onJoin.add(function() {
            console.log("joined-room");
        });
        // new room state
        gameRoom.onUpdate.add(function(state) {
            // this signal is triggered on each patch
            globalState = state;
            updateDOM();
        });

        function updateDOM() {
            console.log(globalState);
            var joinedRoom = -1;
            //clear old data
            var gameRoomList = document.getElementById("current-rooms-tbody");
            gameRoomList.innerHTML = "";

            for (var i = 0; i < globalState.rooms.length; i++) {
                if (globalState.rooms[i].players.indexOf(myPlayerName) > -1) {
                    joinedRoom = i;
                }

                var newRow = document.createElement("tr");
                var roomName = document.createElement("td");
                roomName.className = "room-name";
                roomName.innerHTML = globalState.rooms[i].name;

                var currentNumPlayers = document.createElement("td");
                currentNumPlayers.innerHTML = globalState.rooms[i].players.length;
                var maxPlayers = document.createElement("td");
                maxPlayers.innerHTML = globalState.rooms[i].maxPlayers;
                var joinBtn = document.createElement("td");
                var joinClass = document.createElement("button");
                joinClass.className = "room-join";
                joinClass.innerHTML = "Join";
                joinBtn.className = "join-room";
                // joinBtn.innerHTML = "Join";
                joinBtn.appendChild(joinClass);
                joinBtn.disabled = globalState.rooms[i].players.length == globalState.rooms[i].maxPlayers;

                newRow.appendChild(roomName);
                newRow.appendChild(currentNumPlayers);
                newRow.appendChild(maxPlayers);
                newRow.appendChild(joinBtn);
                gameRoomList.appendChild(newRow);
            }

            // populate bottom section
            if (joinedRoom > -1) {
                //disabled join room buttons
                var el = document.getElementsByClassName("room-join");
                for (var i = 0; i < el.length; i++) {
                    el[i].disabled = true;
                }

                // enable leave button
                document.getElementById("leave-room").disabled = false;

                // Remove all elements in list
                var myNode = document.getElementById("player-list");
                myNode.innerHTML = '';

                if (globalState.rooms[joinedRoom].players.length === globalState.rooms[joinedRoom].readyPlayers.length) {
                    //go to game arena
                }

                for (var j = 0; j < globalState.rooms[joinedRoom].players.length; j++) {
                    var newElement = document.createElement("li");
                    newElement.innerHTML = globalState.rooms[joinedRoom].players[j];

                    if (globalState.rooms[joinedRoom].players.length == globalState.rooms[joinedRoom].maxPlayers) {
                        //prompt players to press ready button
                        if (globalState.rooms[joinedRoom].readyPlayers.indexOf(myPlayerName) === -1) {
                            var readyBtn = document.getElementById("player-ready");
                            readyBtn.disabled = false;
                        }

                        // mark ready players as "IS READY"
                        if (globalState.rooms[joinedRoom].readyPlayers.indexOf(globalState.rooms[joinedRoom].players[j]) > -1) {
                            newElement.innerHTML += " IS READY";
                        }
                    }

                    myNode.appendChild(newElement);
                }

                if (globalState.rooms[joinedRoom].isReady) {
                    $('#arena-url').attr('href', "http://localhost:2657/vrGame/map.html?roomName=" + globalState.rooms[joinedRoom].name);
                    $('#ready-modal').modal('show')
                }
            } else {
                // disable leave button
                document.getElementById("leave-room").disabled = true;
                document.getElementById("player-ready").disabled = true;
            }
        }

        // send data to room on submit
        document.querySelector("#form").onsubmit = function(e) {
            e.preventDefault();
            var roomName = document.querySelector("#game-name");
            var maxPlayers = document.querySelector("#game-max-players");
            // send data to room
            gameRoom.send({
                action: "CREATE",
                payload: {
                    roomName: roomName.value,
                    maxPlayers: maxPlayers.value
                }
            });
            // clear input
            roomName.value = "";
            maxPlayers.value = "";
            document.getElementById("submit-create-room").disabled = true;
        }

        // join room
        $(document).on('click', '.join-room', function(e) {
            var roomName = $(this).siblings('.room-name').innerHTML;
            gameRoom.send({
                action: "JOIN",
                payload: {
                    roomName: roomName
                }
            });
            document.getElementById("submit-create-room").disabled = true;
        });

        // mark ready
        $(document).on('click', '#player-ready', function() {
            gameRoom.send({
                action: "READY"
            });
        });

        $(document).on('click', '#leave-room', function() {
            gameRoom.send({
                action: "LEAVE"
            });
            document.getElementById("player-list").innerHTML = '';
            document.getElementById("submit-create-room").disabled = false;
        });
    </script>
</body>

</html>